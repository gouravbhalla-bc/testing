# syntax=docker/dockerfile:1
#from eu.gcr.io/blockchain-internal/v1/blockchain_python_3_9:latest as base
FROM python:3.9 as base
ARG branch=test-master
env HELM_CHART_PATH=helm
env ALT_REPO_PYPI_USER=centos
env ALT_REPO_PYPI=pypi.altono.app
env ALT_REPO_HELM=https://k8s.altono.app/chartmuseum/api/charts?force
WORKDIR /code
RUN apt update
COPY . .
RUN echo ${branch}
RUN .github/scripts/set-env.sh ${branch}
RUN echo "pypi setup"
RUN .github/scripts/pypi-setup.sh
RUN echo "lint"
RUN bash .github/scripts/common-lint.sh
RUN echo "pypi packaing"
RUN --mount=type=secret,id=bc_env . /run/secrets/bc_env && echo "$PYPI_TOKEN" | base64 --decode > pypi.pem 2>/dev/null
RUN chmod 400 pypi.pem
RUN bash  .github/scripts/pypi-package.sh
RUN echo "Helm Test"
RUN bash .github/scripts/helm-test.sh
RUN echo "Helm Packaging"
RUN bash .github/scripts/helm-package.sh

FROM python:3.9
ARG ALT_REPO_PYPI=pypi.altono.app
COPY --from=base /code/pypi.pem .
WORKDIR /code
COPY requirements.txt requirements.txt
RUN apt-get update
RUN apt-get -y install gcc
RUN pip install -r requirements.txt --extra-index-url=https://${ALT_REPO_PYPI} --trusted-host=${ALT_REPO_PYPI} --use-deprecated=legacy-resolver
EXPOSE 8022
COPY . .
ENTRYPOINT [ "./scripts/start.sh" ]
CMD [ "api" ]
